<!DOCTYPE html>  <html> <head>   <title>tailbone.py</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               tailbone.py             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Appengine abstract restful backend
Intention:
  Try to stay as direct to the appengine api where applicable so it is an easy transition if you
  need to extend this.
  Make the api abstract enough so that any javascript framework will do and so that the same
  frontend could be used with another backend that implements the same api calls.</p>

<p>Ideas:
  Scoping private/public
    Capital is public
    lowercase is private</p>

<p>Open Questions:
    cron job to look for data inconsistencies to notify you if they come up
    so you can ban a user if they are being a problem by storing things in the data set incorrectly.</p>

<pre><code>Send a weekly summary email about statistical outliers and information in your database.

Special names
  CreatedAt or created_at -&gt; auto sets the created at property and can only be modified by the
  server.
  ModifiedAt or modified_at -&gt; where the server sets when it was last modified.

How do you do full text search?
  Searchable{Text} -&gt; if name is searchable it adds this to the full text search api
  /api/search/model?q=text

Realtime binding
  Todo = new tailbone.Model("todos");
  todos = Todo.query({name: "doug"});
  t = new Todo({name: "doug");
  t.$save()
  t.$delete()

  channel listeners bound to queries
  save checks all listened queries for a matching one
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">webapp2</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">from</span> <span class="nn">google.appengine</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">channel</span>
<span class="kn">from</span> <span class="nn">google.appengine.api.images</span> <span class="kn">import</span> <span class="n">get_serving_url_async</span>
<span class="kn">from</span> <span class="nn">google.appengine.api.images</span> <span class="kn">import</span> <span class="n">delete_serving_url</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">blobstore</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">deferred</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">ndb</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">testbed</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext.webapp</span> <span class="kn">import</span> <span class="n">blobstore_handlers</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Custom Exceptions</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">AppError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
  <span class="k">pass</span>

<span class="k">class</span> <span class="nc">BreakError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
  <span class="k">pass</span>

<span class="k">class</span> <span class="nc">LoginError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
  <span class="k">pass</span>


<span class="n">re_public</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;^[A-Z].*&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Model</h2>

<p>A modifed Expando class that all models derive from, this allows app engine to work as an
arbitrary document store for your json objects as well as scope the public private nature of
objects based on the capitolization of the property.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">ScopedExpando</span><span class="p">(</span><span class="n">ndb</span><span class="o">.</span><span class="n">Expando</span><span class="p">):</span>
  <span class="n">owners</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">repeated</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">is_owner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">owners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">owners</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">u</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">owners</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

  <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">excluded</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;owners&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">exluded</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;exclude&quot;</span><span class="p">):</span>
      <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;exclude&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">excluded</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;exclude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">excluded</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ScopedExpando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_owner</span><span class="p">(</span><span class="n">current_user</span><span class="p">()):</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>private and public properties</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="n">result</span><span class="p">[</span><span class="s">&quot;owners&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">owners</span>
    <span class="k">else</span><span class="p">:</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>public properties only</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re_public</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
          <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&quot;Id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>User</h2>

<p>User is an special model that can only be written to by the google account owner.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">users</span><span class="p">(</span><span class="n">ndb</span><span class="o">.</span><span class="n">Expando</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">u</span> <span class="ow">and</span> <span class="n">u</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">id</span><span class="p">():</span>
      <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re_public</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
          <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&quot;Id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Extensions to the jsonifying of python results</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">json_extras</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Extended json processing of types.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;get_result&quot;</span><span class="p">):</span> <span class="c"># RPC</span>
    <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;utctimetuple&quot;</span><span class="p">):</span> <span class="c"># datetime</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">())</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="n">ms</span> <span class="o">+=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;microseconds&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
  <span class="k">return</span> <span class="bp">None</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Decorator to return the result of a function as json. It supports jsonp by default.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns json when callback in url&quot;&quot;&quot;</span>
  <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;application/json&quot;</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Access-Control-Allow-Methods&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;POST,GET,PUT,PATCH,HEAD,OPTIONS&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Access-Control-Allow-Headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Content-Type&quot;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">api</span><span class="o">.</span><span class="n">namespace_manager</span><span class="o">.</span><span class="n">set_namespace</span><span class="p">(</span><span class="n">NAMESPACE</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">resp</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">except</span> <span class="n">BreakError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">return</span>
    <span class="k">except</span> <span class="n">LoginError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
      <span class="n">url</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">create_login_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
      <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
        <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">app_identity</span><span class="o">.</span><span class="n">get_application_id</span><span class="p">()</span> <span class="o">!=</span> <span class="n">testbed</span><span class="o">.</span><span class="n">DEFAULT_APP_ID</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">AppError</span><span class="p">,</span> <span class="n">api</span><span class="o">.</span><span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">,</span>
        <span class="n">api</span><span class="o">.</span><span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
      <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span> <span class="p">}</span>
      <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">app_identity</span><span class="o">.</span><span class="n">get_application_id</span><span class="p">()</span> <span class="o">!=</span> <span class="n">testbed</span><span class="o">.</span><span class="n">DEFAULT_APP_ID</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
      <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">json_extras</span><span class="p">)</span>
    <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;callback&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;text/javascript&quot;</span>
      <span class="n">resp</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">);&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_callback</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">wrapper</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>BaseHandler for error handling</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">BaseHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Log the error.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>If the exception is a HTTPException, use its error code.
Otherwise use a generic 500 error code.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">)}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Reflectively instantiate a class given some data parsed by the restful json POST. If the size of
an object is larger than 500 characters it cannot be indexed. Otherwise everything else is. In the
future there may be a way to express what should be indexed or searchable, but not yet.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">reflective_create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
  <span class="n">m</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="n">m</span><span class="o">.</span><span class="n">_default_indexed</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">_default_indexed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
      <span class="n">subcls</span> <span class="o">=</span> <span class="nb">unicode</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&quot;ignore&quot;</span><span class="p">)</span>
      <span class="n">v</span> <span class="o">=</span> <span class="n">reflective_create</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">subcls</span><span class="p">,</span> <span class="p">(</span><span class="n">ndb</span><span class="o">.</span><span class="n">Expando</span><span class="p">,),</span> <span class="p">{}),</span> <span class="n">v</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
      <span class="n">v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">m</span>

<span class="n">re_json</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;^application/json&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Parse the body of an upload based on the type if you are trying to post a cgi.FieldStorage object
you should instead upload those blob seperately via the special /api/files url.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">parse_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">re_json</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">content_type</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AppError</span><span class="p">(</span><span class="s">&quot;Files should be uploaded seperately as their own form to /api/files/ and </span><span class="se">\</span>
<span class="s">            then their ids should be uploaded and stored with the object.&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
          <span class="n">current</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">,</span><span class="n">v</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
  <span class="k">return</span> <span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Strips any disallowed names {id, _*, etc}.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">clean_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
  <span class="n">disallowed_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Id&quot;</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="s">&quot;key&quot;</span><span class="p">]</span>
  <span class="n">disallowed_prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="s">&quot;$&quot;</span><span class="p">]</span>
  <span class="n">exceptions</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Id&quot;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">disallowed_prefixes</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">disallowed_names</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Disallowed key {</span><span class="si">%s</span><span class="s">} passed in object creation.&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
      <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">data</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Parse the id either given or extracted from the data.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">parse_id</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">data_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
  <span class="k">if</span> <span class="n">data_id</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">data_id</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AppError</span><span class="p">(</span><span class="s">&quot;Url id {</span><span class="si">%s</span><span class="s">} must match object id {</span><span class="si">%s</span><span class="s">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">data_id</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">id</span> <span class="o">=</span> <span class="n">data_id</span>
  <span class="k">return</span> <span class="nb">id</span>

<span class="n">re_filter</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;^([\w\-.]+)(!=|==|=|&lt;=|&gt;=|&lt;|&gt;)(.+)$&quot;</span><span class="p">)</span>
<span class="n">re_composite_filter</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;^(AND|OR)\((.*)\)$&quot;</span><span class="p">)</span>
<span class="n">re_split</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;,\W*&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Convert a value to its inferred python type. Note all numbers are stored as floats which by cause
percision issues in odd cases.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">convert_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s">&quot;false&quot;</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">pass</span>
  <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">convert_opsymbol</span><span class="p">(</span><span class="n">opsymbol</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">opsymbol</span> <span class="o">==</span> <span class="s">&quot;==&quot;</span><span class="p">:</span>
    <span class="n">opsymbol</span> <span class="o">=</span> <span class="s">&quot;=&quot;</span>
  <span class="k">return</span> <span class="n">opsymbol</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Construct an ndb filter from the query args. Example:</p>

<p>www.myurl.com?filter=name==other&amp;filter=size&lt;=5</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">construct_filter</span><span class="p">(</span><span class="n">filter_str</span><span class="p">):</span>
  <span class="n">m</span> <span class="o">=</span> <span class="n">re_composite_filter</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filter_str</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">construct_filter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">re_split</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))]</span>
    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;AND&quot;</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">ndb</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">AND</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">ndb</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">OR</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>
  <span class="n">m</span> <span class="o">=</span> <span class="n">re_filter</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filter_str</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">opsymbol</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ndb</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">FilterNode</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">convert_opsymbol</span><span class="p">(</span><span class="n">opsymbol</span><span class="p">),</span> <span class="n">convert_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">re_split</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filter_str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">construct_filter</span><span class="p">(</span><span class="s">&quot;AND({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filter_str</span><span class="p">))</span>
  <span class="k">raise</span> <span class="n">AppError</span><span class="p">(</span><span class="s">&quot;Filter format is unsupported: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filter_str</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Construct an ndb order from the query args.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">construct_order</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
  <span class="n">neg</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-&quot;</span> <span class="k">else</span> <span class="bp">False</span>
  <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">neg</span> <span class="k">else</span> <span class="n">o</span>
  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">GenericProperty</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
  <span class="k">return</span> <span class="o">-</span><span class="n">p</span> <span class="k">if</span> <span class="n">neg</span> <span class="k">else</span> <span class="n">p</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Construct the filter from a json object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">construct_filter_json</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
  <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;AND&quot;</span><span class="p">:</span>
      <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">construct_filter_json</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
      <span class="k">return</span> <span class="n">ndb</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">AND</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;OR&quot;</span><span class="p">:</span>
      <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">construct_filter_json</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
      <span class="k">return</span> <span class="n">ndb</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">OR</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">name</span><span class="p">,</span> <span class="n">opsymbol</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">f</span>
      <span class="k">return</span> <span class="n">ndb</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">FilterNode</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">convert_opsymbol</span><span class="p">(</span><span class="n">opsymbol</span><span class="p">),</span> <span class="n">convert_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">f</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Construct a query from a json object which includes the filter and order parameters</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">construct_query_from_json</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">orders</span><span class="p">):</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">filters</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">construct_filter_json</span><span class="p">(</span><span class="n">filters</span><span class="p">))</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">construct_filter_json</span><span class="p">(</span><span class="n">filters</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">orders</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">construct_order</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">q</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Construct a query from url args</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">construct_query_from_url_args</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">orders</span><span class="p">):</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">construct_filter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>TODO(doug) correctly auto append orders when necessary like on a multiselect/OR</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">construct_order</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">q</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Determine which kind of query parameters are passed in and construct the query.
Includes paginated results in the response Headers for "More", "Next-Cursor", and "Prev-Cursor"</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
  <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;params&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;page_size&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cursor&quot;</span><span class="p">)</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;filter&quot;</span><span class="p">)</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;order&quot;</span><span class="p">)</span>
    <span class="n">projection</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;projection&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">None</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">construct_query_from_json</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">orders</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;page_size&quot;</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cursor&quot;</span><span class="p">)</span>
    <span class="n">projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;projection&quot;</span><span class="p">)</span>
    <span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">projection</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s">&quot;filter&quot;</span><span class="p">)</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s">&quot;order&quot;</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">construct_query_from_url_args</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">orders</span><span class="p">)</span>
  <span class="n">cursor</span> <span class="o">=</span> <span class="n">Cursor</span><span class="o">.</span><span class="n">from_websafe_string</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span> <span class="k">if</span> <span class="n">cursor</span> <span class="k">else</span> <span class="bp">None</span>

  <span class="n">results</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">more</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">fetch_page</span><span class="p">(</span><span class="n">page_size</span><span class="o">=</span><span class="n">page_size</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;More&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;true&quot;</span> <span class="k">if</span> <span class="n">more</span> <span class="k">else</span> <span class="s">&quot;false&quot;</span>
  <span class="k">if</span> <span class="n">cursor</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Next-Cursor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">urlsafe</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Prev-Cursor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">reversed</span><span class="p">()</span><span class="o">.</span><span class="n">urlsafe</span><span class="p">()</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>This does all the simple restful handling that you would expect. There is a special catch for
/users/me which will look up your logged in id and return your information.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">RestfulHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>TODO(doug) does the model name need to be ascii encoded since types don't support utf-8?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">cls</span> <span class="o">=</span> <span class="n">users</span> <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&quot;users&quot;</span> <span class="k">else</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="p">(</span><span class="n">ScopedExpando</span><span class="p">,),</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&quot;users&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="s">&quot;me&quot;</span><span class="p">:</span>
          <span class="nb">id</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="nb">id</span> <span class="o">=</span> <span class="n">parse_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
      <span class="n">m</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&quot;users&quot;</span><span class="p">:</span>
          <span class="n">m</span> <span class="o">=</span> <span class="n">users</span><span class="p">()</span>
          <span class="n">m</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="s">&quot;users&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">AppError</span><span class="p">(</span><span class="s">&quot;No {} with id {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">set_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&quot;users&quot;</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">id</span> <span class="o">==</span> <span class="s">&quot;me&quot;</span> <span class="ow">or</span> <span class="nb">id</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="nb">id</span> <span class="o">==</span> <span class="n">u</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AppError</span><span class="p">(</span><span class="s">&quot;Id must be the current &quot;</span> <span class="o">+</span>
            <span class="s">&quot;user_id or me. User {} tried to modify user {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="nb">id</span><span class="p">))</span>
      <span class="nb">id</span> <span class="o">=</span> <span class="n">u</span>
      <span class="n">cls</span> <span class="o">=</span> <span class="n">users</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="p">(</span><span class="n">ScopedExpando</span><span class="p">,),</span> <span class="p">{})</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">parse_body</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">parse_id</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Id&quot;</span><span class="p">))</span>
    <span class="n">clean_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">and</span> <span class="n">model</span> <span class="o">!=</span> <span class="s">&quot;users&quot;</span><span class="p">:</span>
      <span class="n">old_model</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">old_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">old_model</span><span class="o">.</span><span class="n">is_owner</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AppError</span><span class="p">(</span><span class="s">&quot;You do not have sufficient privileges.&quot;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">reflective_create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
      <span class="n">m</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">!=</span> <span class="s">&quot;users&quot;</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">owners</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">owners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_or_create</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>TODO: implement this differently to do partial update</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_or_create</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_or_create</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">AppError</span><span class="p">(</span><span class="s">&quot;Must provide an id.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&quot;users&quot;</span><span class="p">:</span>
      <span class="n">u</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">id</span> <span class="o">!=</span> <span class="s">&quot;me&quot;</span> <span class="ow">and</span> <span class="nb">id</span> <span class="o">!=</span> <span class="n">u</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AppError</span><span class="p">(</span><span class="s">&quot;Id must be the current &quot;</span> <span class="o">+</span>
            <span class="s">&quot;user_id or me. User {} tried to modify user {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="nb">id</span><span class="p">))</span>
      <span class="nb">id</span> <span class="o">=</span> <span class="n">u</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">parse_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="nb">id</span><span class="p">)</span>
    <span class="n">key</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{}</span>

<span class="k">class</span> <span class="nc">LoginHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span>
        <span class="n">api</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">create_login_url</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;url&quot;</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="s">&quot;/&quot;</span><span class="p">)))</span>

<span class="k">class</span> <span class="nc">LogoutHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span>
        <span class="n">api</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">create_logout_url</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;url&quot;</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="s">&quot;/&quot;</span><span class="p">)))</span>

<span class="k">class</span> <span class="nc">AdminHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Admin routes&quot;&quot;&quot;</span>
  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">is_current_user_admin</span><span class="p">():</span>
      <span class="k">raise</span> <span class="n">LoginError</span><span class="p">(</span><span class="s">&quot;You must be an admin.&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">notFound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span> <span class="s">&quot;Not Found&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span>
    <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">notFound</span><span class="p">)(</span><span class="bp">self</span><span class="p">)</span>

<span class="n">re_image</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;image/(png|jpeg|jpg|webp|gif|bmp|tiff|ico)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">blob_info_to_dict</span><span class="p">(</span><span class="n">blob_info</span><span class="p">):</span>
  <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;content_type&quot;</span><span class="p">,</span> <span class="s">&quot;creation&quot;</span><span class="p">,</span> <span class="s">&quot;filename&quot;</span><span class="p">,</span> <span class="s">&quot;size&quot;</span><span class="p">]:</span>
    <span class="n">d</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">blob_info</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>
  <span class="n">key</span> <span class="o">=</span> <span class="n">blob_info</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">re_image</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">blob_info</span><span class="o">.</span><span class="n">content_type</span><span class="p">):</span>
    <span class="n">d</span><span class="p">[</span><span class="s">&quot;image_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_serving_url_async</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
  <span class="n">d</span><span class="p">[</span><span class="s">&quot;Id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">d</span>

<span class="k">class</span> <span class="nc">FilesHandler</span><span class="p">(</span><span class="n">blobstore_handlers</span><span class="o">.</span><span class="n">BlobstoreDownloadHandler</span><span class="p">):</span>
  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
      <span class="n">current_user</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">{</span>
          <span class="s">&quot;upload_url&quot;</span><span class="p">:</span> <span class="n">blobstore</span><span class="o">.</span><span class="n">create_upload_url</span><span class="p">(</span><span class="s">&quot;/api/files/upload&quot;</span><span class="p">)</span>
          <span class="p">}</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="n">blob_info</span> <span class="o">=</span> <span class="n">blobstore</span><span class="o">.</span><span class="n">BlobInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">blob_info</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">send_blob</span><span class="p">(</span><span class="n">blob_info</span><span class="p">)</span>
      <span class="k">raise</span> <span class="n">BreakError</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span> <span class="s">&quot;File not found with key &quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">}</span>

  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">AppError</span><span class="p">(</span><span class="s">&quot;You must make a GET call to /api/files to get a POST url.&quot;</span><span class="p">)</span>

  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">AppError</span><span class="p">(</span><span class="s">&quot;PUT is not supported for the files api.&quot;</span><span class="p">)</span>

  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">current_user</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">blobstore</span><span class="o">.</span><span class="n">BlobKey</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
    <span class="n">blob_info</span> <span class="o">=</span> <span class="n">blobstore</span><span class="o">.</span><span class="n">BlobInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">blob_info</span><span class="p">:</span>
      <span class="n">blob_info</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">re_image</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">blob_info</span><span class="o">.</span><span class="n">content_type</span><span class="p">):</span>
        <span class="n">delete_serving_url</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span> <span class="s">&quot;File not found with key &quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">FilesUploadHandler</span><span class="p">(</span><span class="n">blobstore_handlers</span><span class="o">.</span><span class="n">BlobstoreUploadHandler</span><span class="p">):</span>
  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">blob_info_to_dict</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_uploads</span><span class="p">()]</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>converting numbers to strings so that the user id is represented more consistently</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">convert_num_to_str</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
  <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
  <span class="n">num</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
  <span class="n">letters</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span>
  <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">+=</span> <span class="n">letters</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
      <span class="k">break</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">l</span><span class="p">:</span>
      <span class="k">break</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">52</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">+=</span> <span class="n">letters</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">+=</span> <span class="n">letters</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">convert_str_to_num</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
  <span class="n">num</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
    <span class="n">num</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">num</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Fetch the current user id or None</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">current_user</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
  <span class="n">u</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">u</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">convert_num_to_str</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">user_id</span><span class="p">())</span>
  <span class="k">if</span> <span class="n">required</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">LoginError</span><span class="p">(</span><span class="s">&quot;User must be logged in.&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="bp">None</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h2>Event Code</h2>

<p>Not really used directly so you can mostly ignore this section. Has some disabilities as a result
of being on the channel api rather than directly via sockets. Google the channel api and app
engine to learn more.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>The storage and look up of listeners is sharded to reduce conflicts in adding and removing
listeners during simultaneous edits.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">events</span><span class="p">(</span><span class="n">ndb</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="n">NUM_SHARDS</span> <span class="o">=</span> <span class="mi">20</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>
  <span class="n">shard_id</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">IntegerProperty</span><span class="p">()</span>
  <span class="n">listeners</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">IntegerProperty</span><span class="p">(</span><span class="n">repeated</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="n">user_key</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
  <span class="n">event</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">listeners</span> <span class="o">==</span> <span class="n">user_key</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">event</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">event</span>
  <span class="nd">@ndb.transactional</span>
  <span class="k">def</span> <span class="nf">create</span><span class="p">():</span>
    <span class="n">shard_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">NUM_SHARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">event_key</span> <span class="o">=</span> <span class="n">ndb</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="s">&quot;{}_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">))</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">event_key</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
      <span class="n">event</span> <span class="o">=</span> <span class="n">events</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">shard_id</span><span class="o">=</span><span class="n">shard_id</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">event_key</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">listeners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_key</span><span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">event</span>
  <span class="k">return</span> <span class="n">create</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">unbind</span><span class="p">(</span><span class="n">user_key</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="n">eventlist</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">listeners</span> <span class="o">==</span> <span class="n">user_key</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
    <span class="n">eventlist</span> <span class="o">=</span> <span class="n">eventlist</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>
  <span class="n">modified</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nd">@ndb.tasklet</span>
  <span class="nd">@ndb.transactional</span>
  <span class="k">def</span> <span class="nf">remove_from</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">event</span><span class="o">.</span><span class="n">listeners</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">listeners</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="n">user_key</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>
      <span class="k">yield</span> <span class="n">event</span><span class="o">.</span><span class="n">put_async</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">yield</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">delete_async</span><span class="p">()</span>
    <span class="k">raise</span> <span class="n">ndb</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
  <span class="k">return</span> <span class="n">eventlist</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">remove_from</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span> <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                     <span class="s">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span> <span class="p">})</span>
  <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>
      <span class="n">channel</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">listeners</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">send</span><span class="p">),</span> <span class="p">[])</span>

<span class="k">class</span> <span class="nc">ConnectedHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">client_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;from&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">client_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Connecting client id {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_id</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">DisconnectedHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">client_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;from&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">client_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Disconnecting client id {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_id</span><span class="p">))</span>
    <span class="n">unbind</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Remove all event bindings and force all current listeners to close and reconnect.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">RebootHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;REBOOT&quot;</span><span class="p">)</span>
    <span class="n">send_to</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">to_delete</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span> <span class="s">&quot;reboot&quot;</span><span class="p">:</span> <span class="bp">True</span> <span class="p">})</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span><span class="o">.</span><span class="n">query</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">send_to</span><span class="p">:</span>
          <span class="n">sent_to</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
      <span class="n">to_delete</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">():</span>
      <span class="n">ndb</span><span class="o">.</span><span class="n">delete_multi</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span>
    <span class="n">ndb</span><span class="o">.</span><span class="n">transaction</span><span class="p">(</span><span class="n">delete</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">send_to</span><span class="p">:</span>
      <span class="n">deferred</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">send_message</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EventsHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="nd">@as_json</span>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>TODO(doug): add better client_id generation</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">data</span> <span class="o">=</span> <span class="n">parse_body</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">)</span>
    <span class="n">client_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;client_id&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&quot;token&quot;</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">{</span><span class="s">&quot;token&quot;</span><span class="p">:</span> <span class="n">channel</span><span class="o">.</span><span class="n">create_channel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">client_id</span><span class="p">))}</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&quot;bind&quot;</span><span class="p">:</span>
      <span class="n">bind</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&quot;unbind&quot;</span><span class="p">:</span>
      <span class="n">unbind</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&quot;trigger&quot;</span><span class="p">:</span>
      <span class="n">trigger</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;payload&quot;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h2>Some Extra HTML handlers</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">LoginPopupHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">u</span><span class="p">:</span>
      <span class="n">m</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">ndb</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">&lt;!doctype html&gt;</span>
<span class="s">&lt;html&gt;</span>
<span class="s">&lt;head&gt;</span>
<span class="s">  &lt;title&gt;&lt;/title&gt;</span>
<span class="s">&lt;/head&gt;</span>
<span class="s">&lt;body&gt;</span>
<span class="s">If this window does not close, please click &lt;a id=&quot;origin&quot;&gt;here&lt;/a&gt; to refresh.</span>
<span class="s">&lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="s">  var targetOrigin = window.location.origin || ( window.location.protocol + &quot;//&quot; + window.location.host );</span>
<span class="s">  document.querySelector(&quot;#origin&quot;).href = targetOrigin;</span>
<span class="s">  window.opener.postMessage({}, targetOrigin);</span>
<span class="s">  window.close();</span>
<span class="s">&lt;/script&gt;</span>
<span class="s">&lt;/body&gt;</span>
<span class="s">&lt;/html&gt;</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">({</span><span class="s">&quot;type&quot;</span><span class="p">:</span><span class="s">&quot;Login&quot;</span><span class="p">,</span> <span class="s">&quot;payload&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">}))</span>

<span class="n">PREFIX</span> <span class="o">=</span> <span class="s">&quot;/api/&quot;</span>

<span class="n">NAMESPACE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;NAMESPACE&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;SERVER_SOFTWARE&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;Dev&quot;</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">WSGIApplication</span><span class="p">([</span>
  <span class="p">(</span><span class="s">r&quot;{}login&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">),</span> <span class="n">LoginHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&quot;{}login.html&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">),</span> <span class="n">LoginPopupHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&quot;{}logout&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">),</span> <span class="n">LogoutHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&quot;{}admin/(.+)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">),</span> <span class="n">AdminHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&quot;{}files/upload&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">),</span> <span class="n">FilesUploadHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&quot;{}files/?(.*)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">),</span> <span class="n">FilesHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&quot;{}events/.*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">),</span> <span class="n">EventsHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">r&quot;{}([^/]+)/?(.*)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">),</span> <span class="n">RestfulHandler</span><span class="p">),</span>
  <span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">connected</span> <span class="o">=</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">WSGIApplication</span><span class="p">([</span>
  <span class="p">(</span><span class="s">&quot;/_ah/channel/connected/&quot;</span><span class="p">,</span> <span class="n">ConnectedHandler</span><span class="p">),</span>
  <span class="p">(</span><span class="s">&quot;/_ah/channel/disconnected/&quot;</span><span class="p">,</span> <span class="n">DisconnectedHandler</span><span class="p">),</span>
  <span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="n">DEBUG</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 